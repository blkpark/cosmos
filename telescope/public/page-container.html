<link rel="import" href="/vendor/polymer/polymer.html">
<dom-module id="container-item">
    <style>
    :host > div:hover,
    :host > div.selected {
        background-color: #222;
    }
    
    :host > div {
        padding: 10px;
    }
    
    :host p.name {
        font-size: 16px;
        margin-bottom: 2px;
    }
    
    :host span.planet {
        display: inline-block;
        margin-left: 10px;
        font-size: 13px;
        color: #888;
    }
    
    :host span.status {
        font-size: 13px;
        color: #888;
    }
    </style>
    <template>
        <div class="item">
            <p class="name">{{data.Container}}<span class="planet">{{data.Planet}}</span></p>
            <span class="status">{{data.Status.3}}</span>
        </div>
    </template>
</dom-module>
<script>
Polymer({
    is: 'container-item',
    properties: {
        data: {
            type: Object
        }
    }
});
</script>
<dom-module id="page-container">
    <style>
    :host .card.list {
        padding: 0;
    }
    
    @media (min-width: 768px) {
        :host > div {
            width: 100%;
        }
    }
    
    @media (min-width: 1024px) {
        :host > div {
            width: 992px;
            margin: 0 auto;
        }
    }
    
    :host container-item {
        cursor: pointer;
    }
    
    :host .col-md-4,
    :host .col-md-8 {
        padding-left: 5px;
        padding-right: 5px;
    }
    
    :host input.search {
        width: 100%;
        margin-bottom: 5px;
        background-color: #292929;
        border: 1px solid #323232;
        padding: 3px 5px;
    }
    
    :host input.search:focus {
        background-color: #222;
    }
    
    :host .graph h5 {
        text-align: center;
    }
    
    :host .card.graph {
        padding: 10px;
    }
    
    :host .graph > div {
        min-height: 265px;
        cursor: pointer;
    }
    </style>
    <template>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4 col-xs-12">
                    <div>
                        <input type="text" class="search" placeholder="search" style="" />
                    </div>
                    <div id="containerList" class="card list">
                        <template is="x-repeat" items="{{data}}">
                            <container-item data="{{item}}" on-click="onItemClicked"></container-item>
                        </template>
                    </div>
                </div>
                <div class="col-md-8 col-xs-12">
                    <div class="card graph">
                        <div id="cpuUtil" name="Stats.Cpu.TotalUtilization" on-click="onGraphClicked"></div>
                        <h5>CPU Utilization (%)</h5>
                        <div id="memUsage" name="Stats.Memory.Usage" on-click="onGraphClicked"></div>
                        <h5>Memory Usage (MB)</h5>
                        <div id="netIn" name="Stats.Network.RxBytes" on-click="onGraphClicked"></div>
                        <h5>Network In (KB)</h5>
                        <div id="netOut" name="Stats.Network.TxBytes" on-click="onGraphClicked"></div>
                        <h5>Network Out (KB)</h5>
                    </div>
                </div>
            </div>
        </div>
    </template>
</dom-module>
<script>
Polymer({
    is: 'page-container',
    properties: {
        data: {
            type: Array
        },
        charts: {
            type: Array,
            value: []
        }
    },
    _refresh: undefined,
    graphHeight: 250,
    dialogGraphHeight: 400,
    ready: function() {
        this.reload();
    },
    attached: function() {
        this.showEmptyGraph('#cpuUtil');
        this.showEmptyGraph('#memUsage');
        this.showEmptyGraph('#netIn');
        this.showEmptyGraph('#netOut');
    },
    detached: function() {
        if (this._refresh) {
            clearTimeout(this._refresh);
        }
    },
    reload: function() {
        var self = this;
        Cosmos.getContainers(undefined, function(json) {
            self.data = json;
            self.selectItem();
        }, function(jqXHR) {
            console.log('request failed - ' + jqXHR.responseText);
        });
    },
    selectItem: function() {
        var self = this;
        var $this = $(this);
        var fn = function() {
            var items = $this.find('container-item');
            if (items.size() > 0) {
                var e = {};
                if (history.state.key) {
                    items.each(function(i, elem) {
                        if (elem.data.Key == history.state.key) {
                            e.currentTarget = elem;
                        }
                    });
                } else {
                    e.currentTarget = items.get(0);
                }

                if (e.currentTarget) {
                    self.onItemClicked(e);
                }
            } else {
                setTimeout(fn, 80);
            }
        };

        setTimeout(fn, 80);
    },
    onGraphClicked: function(e) {
        var self = this;
        var target = $(e.currentTarget);

        vex.open({
            contentCSS: {
                width: '976px'
            },
            afterOpen: function($vexContent) {
                $vexContent.append($('<div id="graph"/>'));
                var h = $('<h3 style="text-align:center;"/>');
                var title;
                switch (target.attr('name')) {
                    case 'Stats.Cpu.TotalUtilization':
                        title = 'CPU Utilization (%)'
                        break;
                    case 'Stats.Memory.Usage':
                        title = 'Memory Usage (MB)'
                        break;
                    case 'Stats.Network.TxBytes':
                        title = 'Network Out (KB)'
                        break;
                    case 'Stats.Network.RxBytes':
                        title = 'Network In (KB)'
                        break;
                }

                h.text(title);
                $vexContent.append(h);

                self.showDetailGraph(target.attr('key'), target.attr('name'));
                return $vexContent;
            },
            afterClose: function() {}
        });
    },
    onItemClicked: function(e) {
        var selectedItem = $(e.currentTarget);

        var allItems = selectedItem.parent().find('.item');
        var index = selectedItem.get(0).data.Index;
        if (index < 0) return;

        allItems.removeClass('selected');
        $(selectedItem.find('> div')).addClass('selected');

        if (this._refresh) {
            clearTimeout(this._refresh);
        }
        this.showGraph(this.data[index].Key);
    },
    drawGraph: function(selector, width, height, times, data, unit) {
        var dataset = {
            labels: [],
            datasets: [{
                label: "Metrics",
                fillColor: "rgba(72,157,255,0.2)",
                strokeColor: "rgba(72,157,255,1)",
                pointColor: "rgba(72,157,255,1)",
                pointStrokeColor: "#fff",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(72,157,255,1)",
                data: []
            }]
        };
        if (times) {
            dataset.labels = function() {
                var labels = [];
                for (var i = 0; i < times.length; i++) {
                    labels.push(moment(times[i]).format("HH:mm"));
                }
                return labels;
            }();
        }
        if (data) {
            dataset.datasets[0].data = data;
        }
        var container = $('<div/>').css({
            'text-align': 'center'
        });
        var chart = $('<canvas/>').css({
            'display': 'inline-block'
        }).attr('height', height);
        var opt = {
            bezierCurve: false,
            pointHitDetectionRadius: 4,
            scaleLabel: "<%=' ' + value%>",
            scaleFontSize: 12,
            scaleFontColor: '#888',
            tooltipTemplate: "[<%=time%>] <%=value%>" + unit,
            showTooltips: true
        };

        if (isNaN(width)) {
            opt.responsive = true;
            opt.maintainAspectRatio = false;
        } else {
            chart.attr('width', width);
        }

        container.append(chart);
        $(selector).append(container);

        var ctx = chart[0].getContext("2d");
        var chart = new Chart(ctx).Line(dataset, opt);

        var points = chart.datasets[0].points;
        for (var i = 0; i < points.length; i++) {
            points[i].time = moment(times[i]).format("YYYY-MM-DD HH:mm");
        }
        return chart;
    },
    showEmptyGraph: function(selector, unit) {
        var self = this;
        var data = [],
            times = [];

        var now = (new Date()).getTime();
        for (var i = 10; i > 0; i--) {
            data.push(0);
            times.push(now - (i * 60 * 1000));
        }

        setTimeout(function() {
            self.drawGraph(selector, undefined, self.graphHeight, times, data, unit);
        }, 10);
    },
    showDetailGraph: function(key, metric) {
        var self = this;
        var container = this.data[key];
        var planetName = key.split('.')[0];
        var containerName = key.split('.')[1];
        var selector = '#graph';

        Cosmos.getContainerMetrics(planetName, containerName, metric, function(json) {
            switch (metric) {
                case 'Stats.Cpu.TotalUtilization':
                    self._showCpuUsageGraph(selector, json, self.dialogGraphHeight);
                    break;
                case 'Stats.Memory.Usage':
                    self._showMemoryUsageGraph(selector, json, self.dialogGraphHeight);
                    break;
                case 'Stats.Network.RxBytes':
                    self._showNetworkInGraph(selector, json, self.dialogGraphHeight);
                    break;
                case 'Stats.Network.TxBytes':
                    self._showNetworkOutGraph(selector, json, self.dialogGraphHeight);
                    break;
            }

        }, function(jqXHR) {

        });
    },
    _showCpuUsageGraph: function(selector, json, height) {
        var self = this;
        var dataset = json['StatsCpuTotalUtilization'];
        if (dataset == undefined) {
            return;
        }

        var data = [],
            times = [];
        for (var i = dataset.length - 1; i >= 0; i--) {
            data.push(parseInt(dataset[i][2] * 1000) / 1000);
            times.push(dataset[i][0] * 1000);
        }
        $(selector).empty();

        setTimeout(function() {
            self.drawGraph(selector, undefined, height, times, data, '%');
        }, 10);
    },
    _showMemoryUsageGraph: function(selector, json, height) {
        var self = this;
        var dataset = json['StatsMemoryUsage'];
        if (dataset == undefined) {
            return;
        }

        var MB = 1024 * 1024;
        var data = [],
            times = [];
        for (var i = dataset.length - 1; i >= 0; i--) {
            data.push(parseInt(dataset[i][2] / MB));
            times.push(dataset[i][0] * 1000);
        }
        $(selector).empty();

        setTimeout(function() {
            self.drawGraph(selector, undefined, height, times, data, 'MB');
        }, 10);
    },
    _showNetworkInGraph: function(selector, json, height) {
        var self = this;
        var dataset = json['StatsNetworkRxBytes'];
        if (dataset == undefined) {
            return;
        }

        var KB = 1024;
        var data = [],
            times = [];
        for (var i = dataset.length - 1; i >= 0; i--) {
            data.push(parseInt(dataset[i][2] / KB));
            times.push(dataset[i][0] * 1000);
        }
        $(selector).empty();

        setTimeout(function() {
            self.drawGraph(selector, undefined, height, times, data, 'KB');
        }, 10);
    },
    _showNetworkOutGraph: function(selector, json, height) {
        var self = this;
        var dataset = json['StatsNetworkTxBytes'];
        if (dataset == undefined) {
            return;
        }

        var KB = 1024;
        var data = [],
            times = [];
        for (var i = dataset.length - 1; i >= 0; i--) {
            data.push(parseInt(dataset[i][2] / KB));
            times.push(dataset[i][0] * 1000);
        }
        $(selector).empty();

        setTimeout(function() {
            self.drawGraph(selector, undefined, height, times, data, 'KB');
        }, 10);
    },
    showGraph: function(key) {
        var self = this;

        var container = this.data[key];
        var planetName = key.split('.')[0];
        var containerName = key.split('.')[1];

        Cosmos.getContainerMetrics(planetName, containerName, 'all', function(json) {
            $('#cpuUtil').attr('key', key);
            $('#memUsage').attr('key', key);
            $('#netIn').attr('key', key);
            $('#netOut').attr('key', key);

            self._showCpuUsageGraph('#cpuUtil', json, self.graphHeight);
            self._showMemoryUsageGraph('#memUsage', json, self.graphHeight);
            self._showNetworkInGraph('#netIn', json, self.graphHeight);
            self._showNetworkOutGraph('#netOut', json, self.graphHeight);
            self._refresh = setTimeout(function() {
                self.showGraph(key);
            }, 1000 * 60);

        }, function(jqXHR) {
            // failed
            alert('request failed - ' + jqXHR.responseText);
        });
    }
});
</script>
