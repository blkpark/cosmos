<link rel="import" href="/vendor/polymer/polymer.html">
<link rel="import" href="/graph-cpu.html">
<link rel="import" href="/graph-memory.html">
<link rel="import" href="/graph-network-in.html">
<link rel="import" href="/graph-network-out.html">

<!-- Dialog -->
<dom-module id="dialog-metric">
    <style>
    p.title {
        display: inline-block;
        font-weight: bold;
        margin-right: 20px;
    }

    div.controls {
        display: inline-block;
    }
    </style>
    <template>
        <p class="title"></p>
        <div class="controls">
            <label>Last</label>
            <select name="period">
                <option selected="selected" value="30m">30 minutes</option>
                <option value="3h">3 hours</option>
                <option value="8h">8 hours</option>
                <option value="24h">24 hours</option>
            </select>
        </div>
        <div id="graph"></div>
    </template>
</dom-module>
<script>
Polymer({
    is: 'dialog-metric'
});
</script>

<!-- Cosmos Container List Item -->
<dom-module id="cosmos-container-list-item">
    <style>
    .container-list-item {
      padding: 10px;
      border-bottom: 1px solid #333;
      color: #bbb;
    }

    .container-list-item:hover,
    .selected {
        background-color: #489dff;
    }

    .container-list-item:hover span,
    .selected span {
        color: #fff;
    }

    .planet-name {
      color: #bbb;
    }

    .container-name {
      color: #bbb;
    }

    .container-status {
      color: #bbb;
      display: block;
    }
    </style>
    <template>
        <div class="container-list-item" on-click="onContainerClicked">
          <span class="planet-name">{{planetName}}</span>.<span class="container-name">{{containerName}}</span>
          <span class="container-status">{{containerStatus}}</span>
        </div>
    </template>
</dom-module>
<script>
Polymer({
    is: 'cosmos-container-list-item',
    planetName: undefined,
    containerName: undefined,
    containerStatus: undefined,
    $container: undefined,
    $pageContainer: undefined,
    properties: {
        container: {
            type: Object,
            observer: "containerValueChanged"
        },
        isSelected: {
            type: Boolean,
            observer: 'isSelectedValueChanged'
        }
    },
    ready: function() {
      this.$container = $(this).find('.container-list-item');
      this.$pageContainer = $(document.querySelector('cosmos-page-container'));
    },
    attached: function() {
      var self = this;
      setTimeout(function() {
          self.$pageContainer.trigger('onContainerItemReady', self);
      }, 20);
    },
    containerValueChanged: function() {
      this.planetName = this.container.Planet;
      this.containerName = this.container.Container;
      this.containerStatus = this.container.Status[0][3];
    },
    isSelectedValueChanged: function() {
        if (this.isSelected) {
            this.$container.addClass('selected');
            this.$pageContainer.trigger('onContainerItemSelected', this);
        } else {
            this.$container.removeClass('selected');
            this.$pageContainer.trigger('onContainerItemDeselected', this);
        }
    },
    onContainerClicked: function(e) {
      e.preventDefault();
      this.isSelected = !this.isSelected;
    }
});
</script>

<!-- Container Page -->
<dom-module id="cosmos-page-container">
    <style>
    .container {
        width: 100%;
        margin: 0 auto;
        padding: 0;
    }

    @media (min-width: 1080px) {
        .container {
            width: 1080px;
            marign: 0 auto;
        }
    }

    @media (min-width: 1400px) {
        .container {
            width: 1400px;
            margin: 0 auto;
        }
    }

    .row {
        margin: 0;
        padding: 0;
    }

    .left-container {
        width: 100%;
        margin: 0;
        padding: 0;
    }

    @media (min-width: 1080px) {
        .left-container {
            width: 260px;
            padding: 0 10px;
        }
    }

    @media (min-width: 1400px) {
        .left-container {
            width: 320px;
            padding: 0 10px;
        }
    }

    .container-list {
        padding: 20px 0;
    }

    .main-container {
        width: 100%;
        margin: 0;
        padding: 0;
    }

    @media (min-width: 1080px) {
        .main-container {
            width: 720px;
        }
    }

    @media (min-width: 1400px) {
        .main-container {
            width: 1080px;
        }
    }

    .search {
        padding: 10px 20px;
        background-color: #333;
    }

    .search input {
        width: 100%;
        background-color: #333;
        outline: none;
        border: none;
        color: #fff;
    }

    .graph-list {
        padding: 0;
    }
    container-item {
        cursor: pointer;
    }
    </style>
    <template>
        <div class="container">
            <div class="row">
                <div class="left-container col-md-4 col-xs-12">
                    <div class="search">
                        <input id="search-input" type="text" placeholder="search" autocomplete="off" style="" />
                    </div>
                    <div class="container-list">
                        <template id="containerListTemplate" is="x-repeat" items="{{containers}}">
                            <cosmos-container-list-item container="{{item}}"></cosmos-container-list-item>
                        </template>
                    </div>
                </div>
                <div class="main-container col-md-8 col-xs-12">
                    <div class="graph-list">
                      <cosmos-graph-cpu class="graph"></cosmos-graph-cpu>
                      <cosmos-graph-memory class="graph"></cosmos-graph-memory>
                      <cosmos-graph-network-in class="graph"></cosmos-graph-network-in>
                      <cosmos-graph-network-out class="graph"></cosmos-graph-network-out>
                    </div>
                </div>
            </div>
        </div>
    </template>
</dom-module>
<script>
Polymer({
    is: 'cosmos-page-container',
    _refresh: undefined,
    selectedContainerElement: undefined,
    selectedContainerKey: undefined,
    properties: {
        containers: {
            type: Array,
            value: []
        },
        charts: {
            type: Array,
            value: []
        }
    },
    ready: function() {
      this.setContainerItemEventListener();
      this.getContainers();
    },
    attached: function() {

    },
    detached: function() {

    },
    setContainerItemEventListener: function() {
      var self = this;
      $(this).on('onContainerItemSelected', function(e, target) {
        var index = self.$.containerListTemplate.indexForElement(target);
        if (self.selectedContainerElement && self.selectedContainerElement.isSelected) {
            self.selectedContainerElement.isSelected = false;
        }
        self.selectedContainerElement = target;
        self.onContainerClicked(target);
      }).on('onContainerItemDeselected', function(e, target) {
        // nothing to do
      }).on('onContainerItemReady', function(e, target) {
        var index = self.$.containerListTemplate.indexForElement(target);
        if (index != 0 || self.selectedContainerKey) return;
        target.isSelected = true;
      });
    },
    onContainerClicked: function(target) {
      this.getContainerMetrics(target);
    },
    getContainers: function() {
        var self = this;
        var planet = undefined;
        Cosmos.getContainers(planet, function(response) {
            self.containers = response;
            if (self.containers.length == 0) {
              var notification = {
                type: 'information',
                message: 'There is no running container yet.'
              };
              $('cosmos-layout-header').trigger('cosmos-notification', notification);
            }
        }, function(jqXHR) {
            var notification = {
                type: 'error',
                message: 'Cosmos server did not respond any response.'
            };
            $('cosmos-layout-header').trigger('cosmos-notification', notification);
        });
    },
    getContainerMetrics: function(target) {
      var self = this;
      var planet = target.container.Planet;
      var container = target.container.Container;
      var metricType = 'all';
      var period = '';
      Cosmos.getContainerMetrics(planet, container, metricType, period, function(response){
        var $graphs = $(self).find('.graph-list > .graph');

        var totalMetrics = self.getTotalMetrics(response);
        $graphs.each(function(i, target) {
          target.metrics = totalMetrics;
        });
      }, function(jqXHR){
        var notification = {
            type: 'error',
            message: 'Cosmos server did not respond any response.'
        };
        $('cosmos-layout-header').trigger('cosmos-notification', notification);
      });
    },
    getTotalMetrics: function(response) {
      var metrics = {};

      var container = response;
      var keys = Object.keys(container);

      for (var j = 0; j < keys.length; j++) {
        var key = keys[j];
        if (key.match(/^Stats.*/)) {
          var values = container[key];
          var saved = metrics[key];
          if (saved) {
            // sum
            for (var k = 0; k < saved.length; k++) {
              var row = saved[k];
              for (var l = 0; l < values.length; l++) {
                if (row[0] == values[l][0]) {
                  // compare whether two timestamp is same
                  row[2] += values[l][2];
                  break;
                }
              }
            }
          } else {
            // new one
            metrics[key] = values;
          }
        }
      }
      return metrics;
    }
});

/*$('#search-input').keypress(function(e) {
  if (e.keyCode == 13) {
    var containerItems = $("div.container-list").find("container-item");
    var item = undefined;

    for ( var i in containerItems ) {
      if (i == "length") {
        break;
      }
      item = containerItems[i];
      var uncut_name = $(item).find("p").html().split("<span");
      name = uncut_name[0];
      $(item).show();
      if ( name.indexOf(document.getElementById('search-input').value) == -1) {
  $(item).hide();
}
    }
    return false;
  }
});*/
</script>
