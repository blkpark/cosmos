<link rel="import" href="/vendor/polymer/polymer.html">
<dom-module id="planet-containers">
    <style></style>
    <template>
        <template is="x-repeat" items="{{data}}">
            <div style="padding-bottom:10px; padding-left:30px;">
                <span>
                <a href="{{item.Key}}" on-click="onContainerNameClicked">{{item.Names0[3]}}</a>
            </span>
                <span>{{item.Id[3]}}</span>
                <span>{{item.Status[3]}}</span>
            </div>
        </template>
    </template>
</dom-module>
<script>
Polymer({
    is: 'planet-containers',
    properties: {
        data: {
            type: Array,
            value: []

        }
    },
    onContainerNameClicked: function(e) {
        event.preventDefault();
        var target = e.target ||  e.srcElement;
        var key = $(target).attr('href');

        history.pushState({
            page: "container",
            key: key
        }, 'container', '/containers');
    }
});
</script>
<dom-module id="page-planet">
    <style>
    :host > div {
        padding: 0 10px;
    }
    
    :host table {
        width: 100%;
    }
    
    :host thead > tr {
        border-bottom: 2px solid #575757;
        height: 48px;
    }
    
    :host tbody > tr.outer {
        height: 48px;
        color: #bebebe;
    }
    
    :host tbody > tr.inner {
        border-bottom: 1px solid #424242;
        color: #bebebe;
        display: none;
    }
    
    :host tbody > tr > td > paper-checkbox {
        margin-top: 7px;
    }
    </style>
    <template>
        <div>
            <h3>Planets</h3>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th width="30"></th>
                            <th>Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template id="planetTemplate" is="x-repeat" items="{{data}}">
                            <tr class="outer">
                                <td class="check">
                                    <input type="checkbox" value="{{item.Planet}}" on-change="onCheckChanged">
                                    </paper-checkbox>
                                </td>
                                <td>
                                    <b>{{item.Planet}}</b>
                                </td>
                            </tr>
                            <tr class="inner">
                                <td colspan="2">
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </template>
</dom-module>
<script>
Polymer({
    is: 'page-planet',
    properties: {
        data: {
            type: Array,
            value: []
        }
    },
    ready: function() {
        var self = this;
        Cosmos.getPlanets(function(json) {
            self.data = json;
            self.attached();
        }, function(jqXHR) {
            console.log('request faield - ' + jqXHR.responseText);
        });
    },
    attached: function() {
        if (this.data.length > 0 && history.state && history.state.key) {
            var jqElem = $(this);
            var self = this;

            var fn = function() {
                var checkboxes = jqElem.find('input[type=checkbox]');
                if (checkboxes.size() > 0) {
                    checkboxes.each(function(i, elem) {
                        var input = $(elem);
                        if (input.val() == history.state.key) {
                            input.prop('checked', true);
                            self.onCheckChanged({
                                target: elem
                            });
                        }
                    });
                } else {
                    setTimeout(fn, 10);
                }
            };
            setTimeout(fn, 10);
        }
    },
    onCheckChanged: function(e) {
        var self = this;
        var sender = e.target || e.srcElement;
        var checkboxes = $(sender).closest('tbody').find('input[type=checkbox]');

        if (!sender.checked) {
            var innerTr = $(sender).closest('tr').next();
            innerTr.hide();
            innerTr.find('td').empty();
        } else {
            Cosmos.getContainers(sender.value, function(json) {
                var elem = document.createElement('planet-containers');
                elem.data = json;
                var innerTr = $(sender).closest('tr').next();
                innerTr.show();
                Polymer.dom(innerTr.find('td')[0]).appendChild(elem);

            }, function(jqXHR) {
                alert('request failed - ' + jqXHR.responseText);
            });
        }
    }
});
</script>
