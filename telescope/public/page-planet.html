<link rel="import" href="/vendor/polymer/polymer.html">
<link rel="import" href="/graph-cpu.html">
<link rel="import" href="/graph-memory.html">
<link rel="import" href="/graph-network-in.html">
<link rel="import" href="/graph-network-out.html">

<dom-module id="cosmos-planet-list-item">
<style>
.planet-list-item {
    border-bottom: 1px solid #333;
    display: block;
    cursor: pointer;
}

.planet-list-item:hover,
.planet-list-item.selected {
    background-color: #489dff;
}

.planet-list-item a {
    padding: 10px 10px;
    color: #bbb;
    display: block;
    text-decoration: none;
}

.planet-list-item a:hover,
.planet-list-item.selected a {
    color: #fff;
}
</style>
<template>
  <div class="planet-list-item"><a href="#" on-click="onPlanetClicked">{{planet.Planet}}</a></div>
</template>
</dom-module>
<script>
Polymer({
    is: 'cosmos-planet-list-item',
    $container: undefined,
    $pagePlanet: undefined,
    properties: {
        planet: {
            type: Object
        },
        isSelected: {
            type: Boolean,
            observer: 'isSelectedValueChanged'
        }
    },
    ready: function() {
        this.$container = $(this).find('.planet-list-item');
        this.$pagePlanet = $(document.querySelector('cosmos-page-planet'));
    },
    attached: function() {
        var self = this;
        setTimeout(function() {
            self.$pagePlanet.trigger('onPlanetItemReady', self);
        }, 20);
    },
    isSelectedValueChanged: function() {
        if (this.isSelected) {
            this.$container.addClass('selected');
            this.$pagePlanet.trigger('onPlanetItemSelected', this);
        } else {
            this.$container.removeClass('selected');
            this.$pagePlanet.trigger('onPlanetItemDeselected', this);
        }
    },
    onPlanetClicked: function(e) {
        e.preventDefault();
        this.isSelected = !this.isSelected;
    }
});
</script>

<dom-module id="cosmos-page-planet">
<style>
.container {
  width: 100%;
  margin: 0 auto;
  padding: 0;
}

@media (min-width: 1080px) {
  .container {
    width: 1080px;
    marign: 0 auto;
  }
}

@media (min-width: 1400px) {
  .container {
    width: 1400px;
    margin: 0 auto;
  }
}

.row {
  margin: 0;
  padding: 0;
}

.left-container {
  width: 100%;
  margin: 0;
  padding: 0;
}

@media (min-width: 1080px) {
  .left-container {
    width: 260px;
    padding: 0 10px;
  }
}

@media (min-width: 1400px) {
  .left-container {
    width: 320px;
    padding: 0 10px;
  }
}

.planet-list {
  margin: 0;
  padding: 20px 0;
}

.main-container {
  width: 100%;
  margin: 0;
  padding: 0;
}

@media (min-width: 1080px) {
  .main-container {
    width: 720px;
  }
}

@media (min-width: 1400px) {
  .main-container {
    width: 1080px;
  }
}

.search {
  padding: 10px 20px;
  background-color: #333;
}

.search input {
  width: 100%;
  background-color: #333;
  outline: none;
  border: none;
  color: #fff;
}

.graph-list {
  padding: 0;
}
</style>
    <template>
        <div class="container">
            <div class="row">
                <div class="left-container col-md-4 col-xs-12">
                    <div class="search">
                        <input id="search-input" type="text" placeholder="search" style="" />
                    </div>
                    <div class="planet-list">
                        <template id="planetListTemplate" is="x-repeat" items="{{planets}}">
                            <cosmos-planet-list-item planet="{{item}}"></cosmos-planet-list-item>
                        </template>
                    </div>
                </div>
                <div class="main-container col-md-8 col-xs-12">
                    <div class="main-container col-md-8 col-xs-12">
                        <div class="graph-list">
                          <cosmos-graph-cpu class="graph"></cosmos-graph-cpu>
                          <cosmos-graph-memory class="graph"></cosmos-graph-memory>
                          <cosmos-graph-network-in class="graph"></cosmos-graph-network-in>
                          <cosmos-graph-network-out class="graph"></cosmos-graph-network-out>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
</dom-module>
<script>
Polymer({
    is: 'cosmos-page-planet',
    properties: {
        planets: {
            type: Array,
            value: []
        }
    },
    selectedPlanetElement: undefined,
    selectedPlanetKey: undefined,
    loadSelectedPlanetKeyFromState: function() {
        if (history.state && history.state.key) {
            this.selectedPlanetKey = history.state.key;
        } else {
            var keyValues = location.search.split('&');
            if (keyValues.length > 0) {
                for (var i = 0; i < keyValues.length; i++) {
                    var comp = keyValues[i].split('=');
                    if (comp[0] == 'key') {
                        this.selectedPlanetKey = comp[1];
                    }
                }
            }
        }
    },
    ready: function() {
        this.setPlanetItemEventListener();
        // Retrieve planet's list
        this.getPlanets();
    },
    attached: function() {

    },
    detached: function() {

    },
    onPlanetClicked: function(target) {
        this.getMetricsOfPlanet(target);
    },
    setPlanetItemEventListener: function() {
      // Listening select event
      var self = this;
      $(this).on('onPlanetItemSelected', function(e, target) {
          var index = self.$.planetListTemplate.indexForElement(target);
          if (self.selectedPlanetElement && self.selectedPlanetElement.isSelected) {
              self.selectedPlanetElement.isSelected = false;
          }
          self.selectedPlanetElement = target;
          self.onPlanetClicked(target);
      }).on('onPlanetItemDeselected', function(e, target) {
        // nothing to do
      }).on('onPlanetItemReady', function(e, target) {
          var index = self.$.planetListTemplate.indexForElement(target);
          if (!self.selectedPlanetKey && index == 0) {
              // select first item if there's no selectedPlanetKey
              target.isSelected = true;
          }
      });
    },
    getPlanets: function() {
        var self = this;
        Cosmos.getPlanets(function(response) {
            self.planets = response;

            if (self.planets.length == 0) {
                var notification = {
                    type: 'information',
                    message: "There is no running planet yet."
                };
                $('cosmos-layout-header').trigger('cosmos-notification', notification);
            }
        }, function(jqXHR) {
            var notification = {
                type: 'error',
                message: "Cosmos server didn't respond any response."
            };
            $('cosmos-layout-header').trigger('cosmos-notification', notification);
        });
    },
    getMetricsOfPlanet: function(target) {
        // remove planet, container graph runloop
        // set planet graph runloop
        var self = this;
        var planet = target.planet.Planet;

        Cosmos.getMetricsOfPlanet(planet, function(response) {
            var $graphs = $(self).find('.graph-list > .graph');
            var totalMetrics = self.getTotalMetrics(response);
            $graphs.each(function(i, target) {
              target.metrics = totalMetrics;
            });
        }, function(jqXHR) {
            var notification = {
                type: 'error',
                message: 'Cosmos server did not respond any response.'
            };
            $('cosmos-layout-header').trigger('cosmos-notification', notification);
        });
    },
    getTotalMetrics: function(response) {
      var metrics = {};

      for (var i = 0; i < response.length; i++) {
        var container = response[i];
        var keys = Object.keys(container);

        for (var j = 0; j < keys.length; j++) {
          var key = keys[j];
          if (key.match(/^Stats.*/)) {
            var values = container[key];
            var saved = metrics[key];
            if (saved) {
              // sum
              for (var k = 0; k < saved.length; k++) {
                var row = saved[k];
                for (var l = 0; l < values.length; l++) {
                  if (row[0] == values[l][0]) {
                    // compare whether two timestamp is same
                    row[2] += values[l][2];
                    break;
                  }
                }
              }
            } else {
              // new one
              metrics[key] = values;
            }
          }
        }
      }

      return metrics;
    }
});
</script>
