<link rel="import" href="/vendor/polymer/polymer.html">

<dom-module id="planet-containers">
<style></style>
<template>
  <template is="x-repeat" items="{{data}}">
    <div style="padding-bottom:10px; padding-left:30px;">
      <a href="{{item.Key}}" on-click="onContainerNameClicked">{{item.Names0[3]}}</a>
    </div>
  </template>
</template>
</dom-module>
<script>
Polymer({
  is: 'planet-containers',
  properties: {
    data: {
      type: Array,
      value: []
    }
  },
  onContainerNameClicked: function(e) {
    event.preventDefault();
    var target = e.target || e.srcElement;
    var key = $(target).attr('href');

    history.pushState({
      page: "container",
      key: key
    }, 'container', '/containers');
  }
});
</script>

<dom-module id="page-planet">
<style>
:host > div {
    padding: 0 10px;
}

:host .card {
    padding: 0;
}
</style>
<template>
  <div id="planet-list">
    <template is="x-repeat" items="{{data}}">
      <p>{{item.Planet}}</p>
      <!--<container-item data="{{item}}" on-click="onItemClicked"></container-item>-->
    </template>
  </div>
</template>
</dom-module>
<script>
Polymer({
  is: 'page-planet',
  properties: {
    data: {
      type: Array,
      value: []
    }
  },
  ready: function() {
    var self = this;
    Cosmos.getPlanets(function(json) {
      self.data = json;
      self.attached();
    }, function(jqXHR) {
      console.log('request faield - ' + jqXHR.responseText);
    });
  },
  onCellClicked: function(e) {
    var target = $(e.target || e.srcElement);
    var selectedTr = target.parent();
    var allTr = target.closest('tbody').find('tr');

    allTr.removeClass('selected');
    selectedTr.addClass('selected');
    var key = selectedTr.find('td:first').text()

    this.showContainers(key, e);
  },
  attached: function() {
    if (this.data.length > 0 && history.state && history.state.key) {
      var jqElem = $(this);
      var self = this;

      var fn = function() {
        var checkboxes = jqElem.find('input[type=checkbox]');
        if (checkboxes.size() > 0) {
          checkboxes.each(function(i, elem) {
            var input = $(elem);
            if (input.val() == history.state.key) {
              input.prop('checked', true);
              self.onCheckChanged({
                  target: elem
              });
            }
          });
        } else {
          setTimeout(fn, 50);
        }
      };
      setTimeout(fn, 50);
    }
  },
  showContainers: function(key, e) {
    var self = this;
    var sender = e.target || e.srcElement;

    Cosmos.getContainers(key, function(json) {
      var elem = document.createElement('planet-containers');
      elem.data = json;
      var innerTr = $(sender).closest('tr').next();
      innerTr.show();
      innerTr.find('td').empty();
      Polymer.dom(innerTr.find('td')[0]).appendChild(elem);
    }, function(jqXHR) {
      alert('request failed - ' + jqXHR.responseText);
    });
  }
});
</script>
