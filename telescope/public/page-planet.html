<link rel="import" href="/vendor/polymer/polymer.html">
<dom-module id="page-planet">
<style>
.container {
  width: 100%;
  padding: 0;
}

@media (min-width: 1400px) {
  .container {
    width: 1400px;
    margin: 0 auto;
  }
}

.row {
  margin: 0;
}

.list {
  width: 100%;
  margin: 0;
  padding: 0;
  background-color: #222;
}

@media (min-width: 1400px) {
  .list {
    width: 320px;
  }
}

.content {
  width: 100%;
  margin: 0;
  padding: 0;
}

@media (min-width: 1400px) {
  .content {
    width: 1080px;
  }
}

#search {
  padding: 10px;
}

#search input {
  width: 100%;
  color: #000;
}
</style>
<template>

  <div class="container">

    <div class="row">

      <div class="list col-md-4 col-xs-12">
        <div id="search">
          <input type="text" class="search" placeholder="search" style="" />
        </div>

        <div id="planet-list">
          <ul>
            <template is="x-repeat" items="{{data}}">
              <li><a on-click="onPlanetClicked">{{item.Planet}}</a></li>
            </template>
          </ul>
        </div>
      </div>

      <div class="content col-md-8 col-xs-12">
      </div>

    </div>

  </div>
</template>
</dom-module>
<script>
Polymer({
  is: 'page-planet',
  properties: {
    data: {
      type: Array,
      value: []
    }
  },
  ready: function() {
    var self = this;
    Cosmos.getPlanets(function(json) {
      self.data = json;
      self.attached();
    }, function(jqXHR) {
      console.log('request faield - ' + jqXHR.responseText);
    });
  },
  onPlanetClicked: function(e) {
    var self = this;
    var target = $(e.currentTarget);
  },
  onCellClicked: function(e) {
    var target = $(e.target || e.srcElement);
    var selectedTr = target.parent();
    var allTr = target.closest('tbody').find('tr');

    allTr.removeClass('selected');
    selectedTr.addClass('selected');
    var key = selectedTr.find('td:first').text()

    this.showContainers(key, e);
  },
  attached: function() {
    if (this.data.length > 0 && history.state && history.state.key) {
      var jqElem = $(this);
      var self = this;

      var fn = function() {
        var checkboxes = jqElem.find('input[type=checkbox]');
        if (checkboxes.size() > 0) {
          checkboxes.each(function(i, elem) {
            var input = $(elem);
            if (input.val() == history.state.key) {
              input.prop('checked', true);
              self.onCheckChanged({
                  target: elem
              });
            }
          });
        } else {
          setTimeout(fn, 50);
        }
      };
      setTimeout(fn, 50);
    }
  },
  showContainers: function(key, e) {
    var self = this;
    var sender = e.target || e.srcElement;

    Cosmos.getContainers(key, function(json) {
      var elem = document.createElement('planet-containers');
      elem.data = json;
      var innerTr = $(sender).closest('tr').next();
      innerTr.show();
      innerTr.find('td').empty();
      Polymer.dom(innerTr.find('td')[0]).appendChild(elem);
    }, function(jqXHR) {
      alert('request failed - ' + jqXHR.responseText);
    });
  }
});
</script>
