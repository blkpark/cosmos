<link rel="import" href="/vendor/polymer/polymer.html">
<link rel="import" href="/metrics-item-container.html">
<dom-module id="cosmos-chart-planet-cpu">
    <style>
    .cosmos-container {
        width: 100%;
        margin: 0 auto;
        padding: 20px 40px;
        display: block;
    }

    .realtime {
        text-align: right;
        float: right;
        font-size: 24px;
        display: inline-block;
        width: 120px;
        padding-top: 7px;
    }

    .realtime > label {
        display: block;
        font-size: 11px;
        color: #666;
    }

    .chart-container {
        margin-top: 10px;
    }

    .chart-container span.selector {
        padding: 5px 8px;
        color: #333;
    }

    .controller {
        padding: 15px;
        border-top: 1px solid #ccc;
        font-size: 12px;
        text-align: center;
    }

    .title {
        margin-top: 0px;
    }

    .description {
        font-size: 12px;
        color: #888;
    }

    .realtime > .description {
        margin-bottom: 0;
    }

    .chart-wrapper {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background-color: #fdfdfd;
        padding: 10px 10px 10px 0;
    }

    .summary {
      padding: 20px 0;
    }
    </style>
    <template>
        <div id="container" class="cosmos-container">

            <div class="realtime">
                <p class="description">TOTAL</p>
                <b id="realtimeValue">{{total}}</b>
            </div>

            <div>
                <h3 class="title">CPU Utilization</h3>
                <p class="description">A CPU utilization for multiple containers.</p>
            </div>

            <div class="chart-container">
                <div class="controller">
                    <span class="selector">{{startDate}}</span>
                    <span>-</span>
                    <span class="selector">{{endDate}}</span>
                    <b>/ 10min</b>
                </div>

                <div class="chart-wrapper">
                  <div id="chart"></div>
                </div>
            </div>

            <div class="summary">
              <h4>Summary</h4>
              <template id="summaryList" is="dom-repeat" items="{{summaries}}">
                <cosmos-metrics-item-container color="{{item.color}}" label="{{item.label}}" min="{{item.min}}" max="{{item.max}}" average="{{item.average}}" current="{{item.current}}"></cosmos-metrics-item-container>
              </template>
            </div>



            <!--<h4>Related NewsFeeds</h4>-->

        </div>
    </template>
</dom-module>
<script>
Polymer({
    is: 'cosmos-chart-planet-cpu',
    chart: undefined,
    summaries: [],
    startDate: undefined,
    endDate: undefined,
    properties: {

    },
    ready: function() {

    },
    attached: function() {

    },
    detached: function() {

    },
    show: function() {
        if (this.$.chart) this.$.chart.hidden = false;
    },
    hide: function() {
        if (this.$.chart) this.$.chart.hidden = true;
    },
    setChart: function() {
        var chart = c3.generate({
            bindto: this.$.chart,
            data: {
                x: 'date',
                columns: [
                    ['date']
                ]
            },
            point: {
                show: false
            },
            tooltip: {
                show: true
            },
            axis: {
                x: {
                    tick: {
                        outer: false,
                        format: '%m-%d %H:%M'
                    },
                    type: 'timeseries'
                },
                y: {
                    tick: {
                        outer: false
                    },
                    min: 0
                }
            },
            grid: {
                x: {
                    show: true
                },
                y: {
                    show: true
                }
            }
        });

        this.chart = chart;
    },
    load: function(metrics) {
        if (!metrics) return;

        var columns = [
            ['date']
        ];
        var containers = Object.keys(metrics);
        var summaries = [];

        // temp variables
        var container = undefined;
        var values = undefined;
        var time = undefined;
        var value = undefined;
        var min = undefined;
        var max = undefined;
        var average = undefined;
        var sum = undefined;
        var total = 0;
        var startDate = undefined;
        var endDate = undefined;

        // container loop
        for (var i = 0, containerLength = containers.length; i < containerLength; i++) {
            container = containers[i];
            values = metrics[container];
            columns[i + 1] = [container];
            min = max = average = sum = 0;

            // value loop
            for (var j = 0, valueLength = values.length; j < valueLength; j++) {
                time = new Date(values[j][0]);
                value = values[j][1];

                columns[0 + 0][j + 1] = time; // date column
                columns[i + 1][j + 1] = value; // container column

                min = Math.min(min, value);
                max = Math.max(max, value);
                sum += value;

                if (j == 0) startDate = time;
                else if (j == values.length - 1) endDate = time;
            }

            var summary = {
              label: container,
              color: '#29d',
              min: min.toFixed(2) + '%',
              max: max.toFixed(2) + '%',
              average: (sum / values.length).toFixed(2) + '%',
              current: value.toFixed(2) + '%'
            };

            summaries[i] = summary;
            total += value;
        }

        if (!this.chart) this.setChart();
        this.chart.load({
            columns: columns
        });

        this.summaries = summaries;
        this.total = total.toFixed(2) + '%';
        this.startDate = startDate;
        this.endDate = endDate;
        //this.chart.internal.config.data_colors.container_name_key
    }
});
</script>
