<link rel="import" href="/vendor/polymer/polymer.html">
<dom-module id="cosmos-layout-graph">
<style>
.container {
  width: 100%;
  min-height: 265px;
  margin: 0;
  padding: 0;
}

.graph-title {
  margin: 0;
  padding: 0;
  font-size: 17px;
  text-align: center;
}

.graph {
  min-height: 265px;
  cursor: pointer;
}
</style>
<template>
  <div class="container">
    <h3 class="graph-title">{{graphTitle}}</h3>
    <div class="graph"></div>
  </div>
</template>
</dom-module>
<script>
Polymer({
  is: 'cosmos-layout-graph',
  properties: {
    graphId: {
      type: String,
      value: ''
    },
    graphTitle: {
      type: String,
      value: ''
    },
    graphUnit: {
      type: String,
      value: ''
    },
    graphMarginTop: {
      type: String,
      value: '60px'
    }
  },
  ready: function() {
    var selector = '#graph-' + this.graphId;
    var unit = this.graphUnit;
    var period = '10m';

    $(this).find('h3').css('padding-top', this.graphMarginTop).css('padding-bottom', '10px');
    $(this).find('.graph').attr('id', 'graph-' + this.graphId);
    this.showEmptyGraph(selector, unit, period);
  },
  attached: function() {
    // turn on graph runloop
  },
  detached: function() {
    // turn off graph runloop
  },
  setPlanet: function(planet) {
    // remove planet, container graph runloop
    // set planet graph runloop
  },
  setContainer: function(container) {
    // remove planet, container graph runloop
    // set container graph runloop
  },
  showEmptyGraph: function(selector, unit, period) {
    var self = this;
    var data = [],
        times = [],
        points = 10,
        timeWidth = 60 * 1000;

    if (period == '10m') {
        points = 10;
    } else if (period == '30m') {
        points = 30;
    } else if (period == '3h') {
        points = 36;
        timeWidth *= 5;
    } else if (period == '8h') {
        points = 32;
        timeWidth *= 15;
    } else if (period == '24h') {
        points = 24;
        timeWidth *= 60;
    }

    var now = (new Date()).getTime();
    for (var i = points; i > 0; i--) {
      data.push(0);
      times.push(now - (i * timeWidth));
    }

    var height = 265;

    setTimeout(function() {
      self.drawGraph(selector, undefined, height, times, data, unit);
    }, 10);
  },
  drawGraph: function(selector, width, height, times, data, unit, scaleOpt) {
    var dataset = {
      labels: [],
      datasets: [{
        label: 'Metrics',
        fillColor: 'rgba(72,157,255,0.2)',
        strokeColor: 'rgba(72,157,255,1)',
        pointColor: 'rgba(72,157,255,1)',
        pointStrokeColor: '#fff',
        pointHighlightFill: '#fff',
        pointHighlightStroke: 'rgba(72,157,255,1)',
        data: []
      }]
    };
    if (times) {
      dataset.labels = function() {
        var labels = [];
        for (var i = 0; i < times.length; i++) {
          labels.push(moment(times[i]).format('HH:mm'));
        }
        return labels;
      }();
    }
    if (data) {
      dataset.datasets[0].data = data;
    }
    var container = $('<div/>').css({
      'text-align': 'center'
    });
    var chart = $('<canvas/>').css({
      'display': 'inline-block'
    }).attr('height', height);
    var opt = {
      bezierCurve: false,
      pointHitDetectionRadius: 4,
      scaleLabel: "<%=' ' + value%>",
      scaleFontSize: 12,
      scaleFontColor: '#888',
      tooltipTemplate: "[<%=time%>] <%=value%>" + unit,
      showTooltips: true,
      scaleIntegersOnly: false
    };
    if (scaleOpt) {
      var keys = Object.keys(scaleOpt);
      for (var i in keys) {
        opt[keys[i]] = scaleOpt[keys[i]];
      }
    }

    if (isNaN(width)) {
      opt.responsive = true;
      opt.maintainAspectRatio = false;
    } else {
      chart.attr('width', width);
    }

    container.append(chart);
    $(selector).empty().append(container);

    var ctx = chart[0].getContext('2d');
    var chart = new Chart(ctx).Line(dataset, opt);

    var points = chart.datasets[0].points;
    for (var i = 0; i < points.length; i++) {
      points[i].time = moment(times[i]).format('YYYY-MM-DD HH:mm');
    }
    return chart;
  }
});
</script>
